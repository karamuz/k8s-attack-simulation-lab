#attack 

cat <<EOF > attack-sim-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sim-pod
  namespace: default
  labels:
    app: attack-sim
  annotations:
    container.apparmor.security.beta.kubernetes.io/attack-sim: unconfined
spec:
  containers:
  - name: attack-sim
    image: attack-sim:latest
    imagePullPolicy: Never
    securityContext:
      privileged: true
      runAsUser: 0
      capabilities:
        add: ["ALL"]
      seccompProfile:
        type: Unconfined
    env:
    - name: PAYLOAD_SERVER
      value: "payload-server.default.svc.cluster.local"
    - name: PAYLOAD_SERVER_PORT
      value: "8080"
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
    - name: host-fs
      mountPath: /host
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
  - name: host-fs
    hostPath:
      path: /
EOF


#falcosidekick

# Sidekick-UI (2802)
kubectl -n falco port-forward svc/falco-falcosidekick-ui 2802:2802
"Falco Sidekick UI:  http://127.0.0.1:2802  (admin/admin)"

## 1. Start the Kubernetes Cluster

# Start a new Minikube cluster using the Docker driver
minikube start --driver=docker

# CRITICAL: Connect your terminal to Minikube's internal Docker daemon.
# This is the most important step for ensuring images are built in the right place.
eval $(minikube -p minikube docker-env)

## 2. Build the Docker Images

# Ensure you are in the main k8s-attack-simulation-lab/ directory

# Build the vulnerable Jupyter Notebook image
docker build -t insecure-jupyter:latest ./jupyter-notebook

# Build the payload-server (C2) image
docker build -t payload-server:latest ./payload-server

# Build the attack-sim (attacker) image
docker build -t attack-sim:latest ./attack-sim

## 3. Deploy the Initial Infrastructure
# Now, deploy the C2 server, the vulnerable Jupyter pod, and its necessary permissions.

# Grant the default service account cluster-admin privileges
kubectl apply -f kubernetes/0-jupyter-rbac.yaml

# Deploy the payload-server (C2)
kubectl apply -f kubernetes/1-payload-server.yaml

# Deploy the vulnerable Jupyter Notebook pod (our initial access point)
kubectl apply -f kubernetes/0-jupyter-deploy.yaml

# Watch the pods start up (wait for them to be 'Running')
kubectl get pods -w

## 4. Prerequisite Helm Commands
helm repo add falcosecurity https://falcosecurity.github.io/charts
helm repo update
helm upgrade --install falco falcosecurity/falco \
  -n falco --create-namespace \
  -f values-falco-custom.yaml

kubectl get pods -n falco -w


## 5. Simulate the Attack: Initial Access & Execution
# This is the manual part where you act as the attacker.

# forward the port for the Jupyter UI.
kubectl expose deployment misconfigured-jupyter --type=NodePort --port=8888
kubectl rollout status deployment/misconfigured-jupyter
minikube service misconfigured-jupyter --url

# Open your web browser and navigate to jupyter notebook
# In the Jupyter UI, click New > Terminal. You now have a root shell inside the compromised pod.
# Inside the Jupyter terminal you just opened, run the commands to create the attack-sim manifest and deploy it


## 6. Run the metrics.py 

## 7. Take the outputs and run the plots.ipynb in a notebook 